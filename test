import requests
import urllib3
import json

# Wyłącz ostrzeżenia SSL
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# --- KONFIGURACJA ---
GITLAB_URL = "https://gitlab.example.com"  # adres Twojego Gitlaba
PRIVATE_TOKEN = "TWÓJ_TOKEN"               # wstaw swój personal access token
USERNAME = "jankowalski"                   # login użytkownika
OUTPUT_FILE = "events.json"
PER_PAGE = 100
# ---------------------

headers = {"PRIVATE-TOKEN": PRIVATE_TOKEN}

def get_user_id(username: str) -> int:
    """Znajdź ID użytkownika po jego username"""
    url = f"{GITLAB_URL}/api/v4/users"
    params = {"username": username}
    resp = requests.get(url, headers=headers, params=params, verify=False)
    resp.raise_for_status()
    data = resp.json()
    if not data:
        raise ValueError(f"Nie znaleziono użytkownika {username}")
    return data[0]["id"]

def get_all_events(user_id: int):
    """Pobierz całą historię aktywności użytkownika"""
    all_events = []
    page = 1
    while True:
        url = f"{GITLAB_URL}/api/v4/users/{user_id}/events"
        params = {"per_page": PER_PAGE, "page": page}
        resp = requests.get(url, headers=headers, params=params, verify=False)
        resp.raise_for_status()
        events = resp.json()
        if not events:
            break
        all_events.extend(events)
        print(f"Pobrano stronę {page}, łącznie {len(all_events)} zdarzeń")
        page += 1
    return all_events

def main():
    user_id = get_user_id(USERNAME)
    print(f"ID użytkownika {USERNAME}: {user_id}")
    events = get_all_events(user_id)

    with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
        json.dump(events, f, ensure_ascii=False, indent=2)

    print(f"Zapisano {len(events)} zdarzeń do pliku {OUTPUT_FILE}")

if __name__ == "__main__":
    main()
