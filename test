---
- name: Import custom URLs into ASM
  hosts: lb
  connection: local
  gather_facts: no

  vars:
    bigip_host: "{{ ansible_host }}"
    bigip_user: "admin"
    bigip_pass: "haslo"
    policy_id: "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
    urls_file: "/path/to/urls.json"

  tasks:
    - name: Upload urls.json
      ansible.builtin.uri:
        url: "https://{{ bigip_host }}/mgmt/shared/file-transfer/uploads/urls.json"
        method: POST
        user: "{{ bigip_user }}"
        password: "{{ bigip_pass }}"
        force_basic_auth: yes
        body_format: form-multipart
        body:
          file: "{{ lookup('file', urls_file) }}"
        validate_certs: no

    - name: Start import task
      ansible.builtin.uri:
        url: "https://{{ bigip_host }}/mgmt/tm/asm/tasks/import-policy"
        method: POST
        user: "{{ bigip_user }}"
        password: "{{ bigip_pass }}"
        force_basic_auth: yes
        body_format: json
        body:
          filename: "urls.json"
          policyReference:
            link: "https://localhost/mgmt/tm/asm/policies/{{ policy_id }}"
        validate_certs: no
      register: import_task

    - name: Wait for import to finish
      ansible.builtin.uri:
        url: "https://{{ bigip_host }}/mgmt/tm/asm/tasks/import-policy/{{ import_task.json.id }}"
        method: GET
        user: "{{ bigip_user }}"
        password: "{{ bigip_pass }}"
        force_basic_auth: yes
        validate_certs: no
      register: import_status
      until: import_status.json.status == "COMPLETED"
      retries: 30
      delay: 10

    - name: Apply policy
      ansible.builtin.uri:
        url: "https://{{ bigip_host }}/mgmt/tm/asm/tasks/apply-policy"
        method: POST
        user: "{{ bigip_user }}"
        password: "{{ bigip_pass }}"
        force_basic_auth: yes
        body_format: json
        body:
          policyReference:
            link: "https://localhost/mgmt/tm/asm/policies/{{ policy_id }}"
        validate_certs: no
